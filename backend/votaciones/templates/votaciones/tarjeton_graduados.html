<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarjetón Graduados - FESC Votaciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 448 512'><path fill='%23b71c1c' d='M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z'/></svg>">
    <style>
        :root {
            --color-primary: #b71c1c;
            --color-secondary: #e31e24;
            --color-gradient: linear-gradient(90deg, #b71c1c 0%, #e31e24 50%, #b71c1c 100%);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            margin: 0;
            padding: 0;
        }
        
        .container-fluid {
            max-width: 100%;
            padding: 0;
            margin: 0;
        }
        
        .titulo-decorado {
            font-family: 'Segoe UI', sans-serif;
            color: #d40000;
            font-style: italic;
            font-size: 3rem;
            text-align: center;
            font-weight: 500;
            letter-spacing: 1px;
            margin: 20px 0;
        }
        
        .subtitulo-decorado {
            font-family: 'Segoe UI', sans-serif;
            color: #ffffff;
            font-size: 2rem;
            display: block;
            width: 100vw;
            margin-left: 0;
            margin-right: 0;
            background: var(--color-gradient);
            text-align: center;
            text-transform: uppercase;
            font-weight: 900;
            padding: 22px 0;
            margin-bottom: 40px;
        }
        
        .candidates-sections {
            max-width: 100%;
            margin: 16px auto 40px;
            padding: 0 15px; /* Reducido de 40px a 15px */
        }
        
        .planchas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px; /* Reducido de 18px a 15px */
            justify-content: center;
            max-width: 100%;
        }
        
        .plancha-card {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 14px; /* Reducido de 16px a 14px */
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: box-shadow .2s ease, transform .2s ease, border-color .2s ease, background .2s ease;
        }
        
        .plancha-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .plancha-card.selected {
            border-color: #e31e24;
            box-shadow: 0 8px 20px rgba(227,30,36,0.18);
        }
        
        .plancha-card.selected::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(227,30,36,0.08) 0%, rgba(183,28,28,0.15) 100%);
            pointer-events: none;
        }
        
        .plancha-header {
            display: flex;
            align-items: center;
            gap: 8px; /* Reducido de 10px a 8px */
            margin-bottom: 10px; /* Reducido de 12px a 10px */
            position: relative;
            z-index: 1;
        }
        
        .plancha-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 7px; /* Reducido */
            background: #fff4f4;
            color: var(--color-primary);
            border: 1px solid #f1c0c0;
            border-radius: 999px;
            font-size: 10px; /* Reducido de 11px a 10px */
            font-weight: 700;
        }
        
        .plancha-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px; /* Reducido de 24px a 22px */
            height: 22px;
            background: var(--color-secondary);
            color: #fff;
            border-radius: 50%;
            font-size: 10px; /* Reducido de 11px a 10px */
            font-weight: 800;
        }
        
        .plancha-nombre {
            font-size: 13px; /* Reducido de 14px a 13px */
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            line-height: 1.3;
        }
        
        .imagen-tarjeton {
            text-align: center;
            margin-bottom: 10px; /* Reducido de 12px a 10px */
            position: relative;
            z-index: 1;
        }
        
        .imagen-tarjeton img {
            display: block;
            margin: 0 auto;
            width: 100%;
            max-width: 100%; /* Cambiado de 350px a 100% */
            height: auto;
            border-radius: 6px;
            transition: transform 0.3s ease, filter 0.3s ease;
        }
        
        .planchas-grid.has-selection .plancha-card:not(.selected) .imagen-tarjeton img {
            filter: grayscale(1) blur(1px) brightness(0.95);
            transform: none;
        }
        
        .candidatos-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px; /* Reducido de 12px a 10px */
            margin-top: 10px; /* Reducido de 12px a 10px */
            position: relative;
            z-index: 1;
        }
        
        .candidatos-info h6 {
            font-size: 11px; /* Reducido de 12px a 11px */
            margin-bottom: 6px; /* Reducido de 8px a 6px */
            color: var(--color-primary);
        }
        
        .candidato-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0; /* Reducido de 6px a 5px */
            border-bottom: 1px solid #dee2e6;
        }
        
        .candidato-item:last-child {
            border-bottom: none;
        }
        
        .candidato-nombre {
            font-weight: 600;
            color: #333;
            font-size: 11px; /* Reducido de 12px a 11px */
            line-height: 1.3;
        }
        
        .candidato-cargo {
            font-size: 9px; /* Reducido de 10px a 9px */
            color: var(--color-primary);
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .votacion-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px; /* Reducido de 20px a 15px */
            margin: 0 15px 20px; /* Ajustado */
            text-align: center;
        }
        
        .vote-actions {
            text-align: center;
            margin: 20px 0; /* Reducido de 24px a 20px */
        }
        
        .btn-confirmar {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 25px; /* Reducido padding */
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, #e31e24 0%, #b71c1c 100%);
            color: #fff;
            box-shadow: 0 6px 16px rgba(227,30,36,.25);
            font-size: 15px; /* Reducido de 16px a 15px */
            transition: transform .2s ease;
        }
        
        .btn-confirmar:hover {
            transform: translateY(-2px);
            color: #fff;
        }
        
        .btn-confirmar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px; /* Reducido */
            background-color: #666;
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px; /* Reducido de 14px a 13px */
            font-weight: 600;
            margin: 15px; /* Reducido de 20px a 15px */
        }
        
        /* Modal SIMPLIFICADO */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.7);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px; /* Reducido de 20px a 15px */
            box-sizing: border-box;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
        }
        
        .modal {
            background: white;
            border-radius: 12px; /* Reducido de 16px a 12px */
            max-width: 90%; /* Cambiado de 500px a 90% */
            width: 100%;
            max-height: 85vh; /* Reducido de 80vh a 85vh */
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,.5);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            background: var(--color-primary);
            color: white;
            padding: 15px; /* Reducido de 20px a 15px */
            border-radius: 12px 12px 0 0;
            margin: 0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 16px; /* Reducido de 18px a 16px */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px; /* Reducido de 10px a 8px */
        }
        
        .modal-body {
            padding: 15px; /* Reducido de 20px a 15px */
        }
        
        .modal-body p {
            margin: 0 0 12px 0; /* Reducido */
            color: #555;
            line-height: 1.5;
            font-size: 14px; /* Añadido */
        }
        
        .modal-summary {
            background: #f8f9fa;
            border-radius: 6px; /* Reducido de 8px a 6px */
            padding: 12px; /* Reducido de 15px a 12px */
            margin: 12px 0; /* Reducido de 15px a 12px */
        }
        
        .modal-summary h4 {
            margin: 0 0 8px 0; /* Reducido de 10px a 8px */
            font-size: 14px; /* Reducido de 16px a 14px */
            color: var(--color-primary);
            font-weight: 600;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0; /* Reducido de 8px a 6px */
            border-bottom: 1px solid #dee2e6;
            font-size: 13px; /* Añadido */
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-consejo {
            font-weight: 600;
            color: #333;
            font-size: 13px; /* Reducido de 14px a 13px */
        }
        
        .summary-plancha {
            color: var(--color-primary);
            font-weight: 600;
            font-size: 13px; /* Reducido de 14px a 13px */
        }
        
        .warning-text {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px; /* Reducido de 8px a 6px */
            padding: 10px; /* Reducido de 12px a 10px */
            margin: 12px 0; /* Reducido */
            color: #856404;
            font-size: 13px; /* Reducido de 14px a 13px */
            display: flex;
            align-items: center;
            gap: 6px; /* Reducido de 8px a 6px */
        }
        
        .modal-footer {
            padding: 12px 15px 15px; /* Reducido */
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border-radius: 6px; /* Reducido de 8px a 6px */
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px; /* Reducido de 14px a 13px */
            transition: all 0.2s ease;
            min-width: 80px; /* Reducido de 100px a 80px */
        }
        
        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn.secondary:hover {
            background: #545b62;
        }
        
        .modal-btn.primary {
            background: var(--color-primary);
            color: white;
        }
        
        .modal-btn.primary:hover {
            background: #a01818;
        }
        
        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        
        .need-selection {
            animation: shake .5s linear both;
        }
        
        /* Responsive mejorado */
        @media (max-width: 1200px) {
            .planchas-grid {
                grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
                gap: 12px;
            }
        }
        
        @media (max-width: 768px) {
            .titulo-decorado { font-size: 2.2rem; margin-top: 15px; }
            .subtitulo-decorado { font-size: 1.3rem; padding: 12px 0; margin-bottom: 25px; }
            .candidates-sections { padding: 0 10px; }
            
            .planchas-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 10px;
            }
            
            .plancha-card { padding: 10px; }
            .plancha-header { gap: 6px; margin-bottom: 8px; }
            .plancha-chip { font-size: 9px; padding: 2px 5px; }
            .plancha-num { width: 20px; height: 20px; font-size: 9px; }
            .plancha-nombre { font-size: 12px; }
            .candidato-nombre { font-size: 10px; }
            .candidato-cargo { font-size: 8px; }
            
            .modal {
                margin: 5px;
                max-width: calc(100vw - 10px);
                max-height: 90vh;
            }
            
            .modal-footer {
                flex-direction: column-reverse;
            }
            
            .modal-btn {
                width: 100%;
                min-width: auto;
            }
            
            .votacion-info {
                margin: 0 10px 15px;
                padding: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .planchas-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .candidates-sections { padding: 0 8px; }
            .titulo-decorado { font-size: 1.9rem; }
            .subtitulo-decorado { font-size: 1.1rem; padding: 10px 0; }
        }
        
        @media (max-width: 420px) {
            .plancha-card { padding: 8px; }
            .plancha-chip { font-size: 8px; }
            .plancha-num { width: 18px; height: 18px; font-size: 8px; }
            .votacion-info { margin: 0 8px 12px; padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="votacion-info">
            <h4><i class="fas fa-user-graduate"></i> Votación Graduados</h4>
            <p class="mb-0">Bienvenido/a: <strong>{{ votante_nombre }}</strong></p>
            <small class="text-muted">Seleccione una plancha por cada consejo</small>
        </div>

        <h2 class="titulo-decorado">. Graduados .</h2>

        <form method="post" action="{% url 'votaciones:procesar_voto' %}" id="votacion-form">
            {% csrf_token %}
            
            {% for consejo, planchas in planchas_por_consejo.items %}
            <section class="candidates-sections">
                <h2 class="subtitulo-decorado">{{ consejo.nombre }}</h2>
                <div class="planchas-grid" data-consejo="{{ consejo.id }}">
                    {% for plancha in planchas %}
                    <div class="plancha-card" data-consejo="{{ consejo.id }}" data-plancha="{{ plancha.id }}">
                        <div class="plancha-header">
                            <span class="plancha-chip">Plancha</span>
                            <span class="plancha-num">{{ plancha.numero|stringformat:"02d" }}</span>
                        </div>
                        
                        <div class="plancha-nombre">{{ plancha.nombre }}</div>
                        
                        {% if plancha.imagen_tarjeton %}
                        <div class="imagen-tarjeton">
                            <img src="{{ plancha.imagen_tarjeton.url }}" alt="{{ plancha.nombre }}">
                        </div>
                        {% endif %}
                        
                        {% if plancha.candidatos.all %}
                        <div class="candidatos-info">
                            <h6><i class="fas fa-users"></i> Candidatos:</h6>
                            {% for candidato in plancha.candidatos.all %}
                            <div class="candidato-item">
                                <span class="candidato-nombre">{{ candidato.nombre }}</span>
                                <span class="candidato-cargo">{{ candidato.get_cargo_display }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <input type="radio" name="voto_{{ consejo.id }}" value="{{ plancha.id }}" style="display: none;">
                    </div>
                    {% empty %}
                    <div class="col-12 text-center">
                        <p class="text-muted">No hay planchas disponibles para este consejo</p>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% empty %}
            <div class="text-center">
                <p class="text-muted">No hay planchas disponibles para graduados</p>
            </div>
            {% endfor %}
            
            <div class="vote-actions">
                <button type="button" class="btn-confirmar" id="registerVote">
                    <i class="fas fa-vote-yea"></i> Registrar Voto
                </button>
            </div>
        </form>

        <!-- Modal SIMPLIFICADO - Copiar HTML desde tarjeton_estudiantes.html -->
        <div class="modal-overlay" id="confirmModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>
                        <i class="fas fa-exclamation-triangle"></i>
                        Confirmar Votación
                    </h3>
                </div>
                <div class="modal-body">
                    <p>Está a punto de registrar su voto con las siguientes selecciones:</p>
                    
                    <div class="modal-summary">
                        <h4><i class="fas fa-check-circle"></i> Resumen de su votación:</h4>
                        <div id="summaryList"></div>
                    </div>
                    
                    <div class="warning-text">
                        <i class="fas fa-info-circle"></i>
                        <strong>¡IMPORTANTE!</strong> Esta acción no se puede deshacer. Una vez confirmado, su voto será registrado permanentemente.
                    </div>
                    
                    <p>¿Está seguro de que desea confirmar su votación?</p>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn secondary" id="cancelConfirm">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="modal-btn primary" id="confirmVote">
                        <i class="fas fa-check"></i> Confirmar Voto
                    </button>
                </div>
            </div>
        </div>

        <div class="text-center">
            <a href="{% url 'votaciones:index' %}" class="back-button">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <script>
        // Selección por sección con efecto visual
        (function(){
            document.querySelectorAll('.planchas-grid').forEach(grid => {
                grid.addEventListener('click', (ev) => {
                    const card = ev.target.closest('.plancha-card');
                    if(!card || !grid.contains(card)) return;
                    
                    const isSelected = card.classList.contains('selected');
                    
                    // Deseleccionar todas las tarjetas del grid
                    grid.querySelectorAll('.plancha-card').forEach(c => c.classList.remove('selected'));
                    
                    if(isSelected){
                        grid.classList.remove('has-selection');
                        // Desmarcar radio
                        const radio = card.querySelector('input[type="radio"]');
                        if(radio) radio.checked = false;
                        return;
                    }
                    
                    // Seleccionar tarjeta
                    card.classList.add('selected');
                    grid.classList.add('has-selection');
                    
                    // Marcar radio
                    const radio = card.querySelector('input[type="radio"]');
                    if(radio) radio.checked = true;
                });
            });
        })();

        // Validación y modal de confirmación
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('confirmModal');
            const registerBtn = document.getElementById('registerVote');
            const summaryContainer = document.getElementById('summaryList');
            const cancelBtn = document.getElementById('cancelConfirm');
            const confirmBtn = document.getElementById('confirmVote');
            const form = document.getElementById('votacion-form');

            function getSectionSelections(){
                const result = [];
                document.querySelectorAll('.candidates-sections').forEach(section => {
                    const title = section.querySelector('.subtitulo-decorado')?.textContent?.trim() || 'Sección';
                    const grid = section.querySelector('.planchas-grid');
                    const sel = grid ? grid.querySelector('.plancha-card.selected') : null;
                    result.push({ sectionEl: section, title, grid, sel });
                });
                return result;
            }

            function openModal(items){
                console.log('Abriendo modal...'); // Debug
                summaryContainer.innerHTML = '';
                
                items.forEach(item => {
                    const num = item.sel ? (item.sel.querySelector('.plancha-num')?.textContent || '') : '';
                    const nombre = item.sel ? (item.sel.querySelector('.plancha-nombre')?.textContent || '') : '';
                    const label = nombre ? `Plancha ${num} - ${nombre}` : `Plancha ${num}`;
                    
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'summary-item';
                    summaryItem.innerHTML = `
                        <span class="summary-consejo">${item.title}</span>
                        <span class="summary-plancha">${label}</span>
                    `;
                    summaryContainer.appendChild(summaryItem);
                });
                
                // Mostrar modal
                overlay.style.display = 'flex';
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                console.log('Modal debería estar visible'); // Debug
            }

            function closeModal(){ 
                console.log('Cerrando modal...'); // Debug
                overlay.classList.remove('active');
                overlay.style.display = 'none';
                document.body.style.overflow = '';
                
                // Restaurar estado del botón
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check"></i> Confirmar Voto';
                }
            }

            if (registerBtn) {
                registerBtn.addEventListener('click', function() {
                    console.log('Botón clicked'); // Debug
                    const data = getSectionSelections();
                    const missing = data.filter(d => !d.sel);
                    
                    if(missing.length){
                        console.log('Faltan selecciones:', missing.length); // Debug
                        // Resaltar primera sección faltante
                        const m = missing[0];
                        if (m.grid) {
                            m.grid.classList.add('need-selection');
                            m.grid.scrollIntoView({ behavior:'smooth', block:'center' });
                            setTimeout(() => m.grid.classList.remove('need-selection'), 700);
                        }
                        return;
                    }
                    
                    console.log('Todas las selecciones hechas, abriendo modal...'); // Debug
                    openModal(data);
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeModal();
                });
            }
            
            // Cerrar modal al hacer clic fuera
            if (overlay) {
                overlay.addEventListener('click', function(e) { 
                    if(e.target === overlay) {
                        closeModal();
                    }
                });
            }
            
            // Confirmar voto
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                    
                    setTimeout(() => {
                        if (form) {
                            form.submit();
                        }
                    }, 500);
                });
            }

            // Manejar tecla Escape para cerrar modal
            document.addEventListener('keydown', function(e) {
                if(e.key === 'Escape' && overlay && overlay.classList.contains('active')) {
                    closeModal();
                }
            });

            // Debug: verificar que los elementos existen
            console.log('Elementos encontrados:', {
                overlay: !!overlay,
                registerBtn: !!registerBtn,
                summaryContainer: !!summaryContainer,
                cancelBtn: !!cancelBtn,
                confirmBtn: !!confirmBtn,
                form: !!form
            });
        });
    </script>
</body>
</html>
