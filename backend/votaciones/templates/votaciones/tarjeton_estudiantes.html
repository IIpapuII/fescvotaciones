<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarjetón Estudiantes - FESC Votaciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #b71c1c;
            --color-secondary: #e31e24;
            --color-gradient: linear-gradient(90deg, #b71c1c 0%, #e31e24 50%, #b71c1c 100%);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
        }
        
        .titulo-decorado {
            font-family: 'Segoe UI', sans-serif;
            color: #d40000;
            font-style: italic;
            font-size: 3rem;
            text-align: center;
            font-weight: 500;
            letter-spacing: 1px;
            margin: 30px 0;
        }
        
        .subtitulo-decorado {
            font-family: 'Segoe UI', sans-serif;
            color: #ffffff;
            font-size: 2rem;
            display: block;
            width: 100vw;
            margin-left: calc(50% - 50vw);
            margin-right: calc(50% - 50vw);
            background: var(--color-gradient);
            text-align: center;
            text-transform: uppercase;
            font-weight: 900;
            padding: 22px 0;
            margin-bottom: 60px;
        }
        
        .candidates-sections {
            max-width: 1400px;
            margin: 16px auto 60px;
            padding: 0 40px;
        }
        
        .planchas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 18px;
            justify-content: center;
        }
        
        .plancha-card {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: box-shadow .2s ease, transform .2s ease, border-color .2s ease, background .2s ease;
        }
        
        .plancha-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .plancha-card.selected {
            border-color: #e31e24;
            box-shadow: 0 8px 20px rgba(227,30,36,0.18);
        }
        
        .plancha-card.selected::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(227,30,36,0.08) 0%, rgba(183,28,28,0.15) 100%);
            pointer-events: none;
        }
        
        .plancha-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }
        
        .plancha-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: #fff4f4;
            color: var(--color-primary);
            border: 1px solid #f1c0c0;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .plancha-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--color-secondary);
            color: #fff;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 800;
        }
        
        .plancha-nombre {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            line-height: 1.3;
        }
        
        .imagen-tarjeton {
            text-align: center;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }
        
        .imagen-tarjeton img {
            display: block;
            margin: 0 auto;
            width: 100%;
            max-width: 350px;
            height: auto;
            border-radius: 6px;
            transition: transform 0.3s ease, filter 0.3s ease;
        }
        
        .planchas-grid.has-selection .plancha-card:not(.selected) .imagen-tarjeton img {
            filter: grayscale(1) blur(1px) brightness(0.95);
            transform: none;
        }
        
        .candidatos-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            position: relative;
            z-index: 1;
        }
        
        .candidatos-info h6 {
            font-size: 12px;
            margin-bottom: 8px;
            color: var(--color-primary);
        }
        
        .candidato-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .candidato-item:last-child {
            border-bottom: none;
        }
        
        .candidato-nombre {
            font-weight: 600;
            color: #333;
            font-size: 12px;
            line-height: 1.3;
        }
        
        .candidato-cargo {
            font-size: 10px;
            color: var(--color-primary);
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .votacion-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .vote-actions {
            text-align: center;
            margin: 24px 0;
        }
        
        .btn-confirmar {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 15px 30px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, #e31e24 0%, #b71c1c 100%);
            color: #fff;
            box-shadow: 0 6px 16px rgba(227,30,36,.25);
            font-size: 16px;
            transition: transform .2s ease;
        }
        
        .btn-confirmar:hover {
            transform: translateY(-2px);
            color: #fff;
        }
        
        .btn-confirmar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background-color: #666;
            color: #fff;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            margin: 20px 0;
        }
        
        /* ——— MODAL PERSONALIZADO (sin colisión con Bootstrap) ——— */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.show { display: flex !important; animation: fadeIn 0.3s ease; }

        .custom-modal {
            background: #fff;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 0;
            box-shadow: 0 20px 50px rgba(0,0,0,.5);
            animation: slideUp 0.3s ease;
            position: relative;
            z-index: 10000;
        }
        
        .custom-modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .custom-modal-header h3 {
            margin: 0;
            font-size: 22px;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .custom-modal-body { padding: 20px 24px; }
        .custom-modal-body p { margin: 0 0 16px; color: #555; line-height: 1.6; }
        
        .modal-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0 20px;
        }
        .modal-summary h4 { margin: 0 0 12px; font-size: 16px; color: var(--color-primary); }
        .summary-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid #e9ecef;
        }
        .summary-item:last-child { border-bottom: none; }
        .summary-consejo { font-weight: 600; color: #333; font-size: 14px; }
        .summary-plancha { color: var(--color-primary); font-weight: 600; font-size: 14px; }
        
        .warning-text {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            color: #856404;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .custom-modal-footer {
            padding: 16px 24px 24px;
            display: flex; gap: 12px; justify-content: flex-end;
        }
        .modal-btn {
            padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;
            font-weight: 600; font-size: 14px; transition: all 0.2s ease; min-width: 100px;
        }
        .modal-btn.secondary { background: #f8f9fa; color: #666; border: 1px solid #dee2e6; }
        .modal-btn.secondary:hover { background: #e9ecef; }
        .modal-btn.primary { background: linear-gradient(135deg, #e31e24 0%, #b71c1c 100%); color: #fff; }
        .modal-btn.primary:hover { background: var(--color-primary); transform: translateY(-1px); }
        
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp {
            from { opacity:0; transform: translateY(30px) scale(0.95); }
            to { opacity:1; transform: translateY(0) scale(1); }
        }
        @keyframes shake {
            10%,90%{transform:translateX(-1px)}
            20%,80%{transform:translateX(2px)}
            30%,50%,70%{transform:translateX(-4px)}
            40%,60%{transform:translateX(4px)}
        }
        .need-selection { animation: shake .5s linear both; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .titulo-decorado { font-size: 2.2rem; margin-top: 18px; }
            .subtitulo-decorado { font-size: 1.3rem; padding: 14px 0; margin-bottom: 36px; }
            .candidates-sections { padding: 0 20px; }
            .planchas-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
            .plancha-card { padding: 12px; }
            .plancha-header { gap: 8px; margin-bottom: 10px; }
            .plancha-chip { font-size: 10px; padding: 3px 6px; }
            .plancha-num { width: 22px; height: 22px; font-size: 10px; }
            .plancha-nombre { font-size: 13px; }
            .candidato-nombre { font-size: 11px; }
            .candidato-cargo { font-size: 9px; }
            .custom-modal { margin: 10px; max-width: calc(100vw - 20px); }
            .custom-modal-footer { flex-direction: column-reverse; }
            .modal-btn { width: 100%; }
        }
        @media (max-width: 480px) {
            .planchas-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; }
        }
        @media (max-width: 420px) {
            .titulo-decorado { font-size: 1.9rem; }
            .subtitulo-decorado { font-size: 1.15rem; padding: 12px 0; }
            .planchas-grid { grid-template-columns: 1fr; }
            .plancha-card { padding: 10px; }
            .plancha-chip { font-size: 9px; }
            .plancha-num { width: 20px; height: 20px; font-size: 9px; }
        }
    </style>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 448 512'><path fill='%23b71c1c' d='M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z'/></svg>">
</head>
<body>
    <div class="container-fluid">
        <div class="votacion-info">
            <h4><i class="fas fa-user-graduate"></i> Votación Estudiantes</h4>
            <p class="mb-0">Bienvenido/a: <strong>{{ votante_nombre }}</strong></p>
            <small class="text-muted">Seleccione una plancha por cada consejo</small>
        </div>

        <h2 class="titulo-decorado">. Estudiantes .</h2>

        <form method="post" action="{% url 'votaciones:procesar_voto' %}" id="votacion-form">
            {% csrf_token %}
            
            {% for consejo, planchas in planchas_por_consejo.items %}
            <section class="candidates-sections">
                <h2 class="subtitulo-decorado">{{ consejo.nombre }}</h2>
                <div class="planchas-grid" data-consejo="{{ consejo.id }}">
                    {% for plancha in planchas %}
                    <div class="plancha-card" data-consejo="{{ consejo.id }}" data-plancha="{{ plancha.id }}">
                        <div class="plancha-header">
                            <span class="plancha-chip">Plancha</span>
                            <span class="plancha-num">{{ plancha.numero|stringformat:"02d" }}</span>
                        </div>
                        
                        <div class="plancha-nombre">{{ plancha.nombre }}</div>
                        
                        {% if plancha.imagen_tarjeton %}
                        <div class="imagen-tarjeton">
                            <img src="{{ plancha.imagen_tarjeton.url }}" alt="{{ plancha.nombre }}">
                        </div>
                        {% endif %}
                        
                        {% if plancha.candidatos.all %}
                        <div class="candidatos-info">
                            <h6><i class="fas fa-users"></i> Candidatos:</h6>
                            {% for candidato in plancha.candidatos.all %}
                            <div class="candidato-item">
                                <span class="candidato-nombre">{{ candidato.nombre }}</span>
                                <span class="candidato-cargo">{{ candidato.get_cargo_display }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <input type="radio" name="voto_{{ consejo.id }}" value="{{ plancha.id }}" style="display: none;">
                    </div>
                    {% empty %}
                    <div class="col-12 text-center">
                        <p class="text-muted">No hay planchas disponibles para este consejo</p>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% empty %}
            <div class="text-center">
                <p class="text-muted">No hay planchas disponibles para estudiantes</p>
            </div>
            {% endfor %}
            
            <div class="vote-actions">
                <button type="button" class="btn-confirmar" id="registerVote">
                    <i class="fas fa-vote-yea"></i> Registrar Voto
                </button>
            </div>
        </form>

        <!-- Modal de confirmación (renombrado para evitar conflicto con Bootstrap) -->
        <div class="modal-overlay" id="confirmOverlay" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
            <div class="custom-modal">
                <div class="custom-modal-header">
                    <h3 id="confirmTitle">
                        <i class="fas fa-exclamation-triangle"></i>
                        Confirmar Votación
                    </h3>
                </div>
                <div class="custom-modal-body">
                    <p>Está a punto de registrar su voto con las siguientes selecciones:</p>
                    
                    <div class="modal-summary">
                        <h4><i class="fas fa-check-circle"></i> Resumen de su votación:</h4>
                        <div id="summaryList"></div>
                    </div>
                    
                    <div class="warning-text">
                        <i class="fas fa-info-circle"></i>
                        <strong>¡IMPORTANTE!</strong> Esta acción no se puede deshacer. Una vez confirmado, su voto será registrado permanentemente.
                    </div>
                    
                    <p>¿Está seguro de que desea confirmar su votación?</p>
                </div>
                <div class="custom-modal-footer">
                    <button class="modal-btn secondary" id="cancelConfirm">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="modal-btn primary" id="confirmVote">
                        <i class="fas fa-check"></i> Confirmar Voto
                    </button>
                </div>
            </div>
        </div>

        <div class="text-center">
            <a href="{% url 'votaciones:index' %}" class="back-button">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <script>
        // Selección por sección con efecto visual
        (function(){
            document.querySelectorAll('.planchas-grid').forEach(grid => {
                grid.addEventListener('click', (ev) => {
                    const card = ev.target.closest('.plancha-card');
                    if(!card || !grid.contains(card)) return;
                    
                    const isSelected = card.classList.contains('selected');
                    grid.querySelectorAll('.plancha-card').forEach(c => c.classList.remove('selected'));
                    
                    if(isSelected){
                        grid.classList.remove('has-selection');
                        const radio = card.querySelector('input[type="radio"]');
                        if(radio) radio.checked = false;
                        return;
                    }
                    
                    card.classList.add('selected');
                    grid.classList.add('has-selection');
                    const radio = card.querySelector('input[type="radio"]');
                    if(radio) radio.checked = true;
                });
            });
        })();

        // Validación y modal de confirmación
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('confirmOverlay');
            const registerBtn = document.getElementById('registerVote');
            const summaryContainer = document.getElementById('summaryList');
            const cancelBtn = document.getElementById('cancelConfirm');
            const confirmBtn = document.getElementById('confirmVote');
            const form = document.getElementById('votacion-form');

            function getSectionSelections(){
                const result = [];
                document.querySelectorAll('.candidates-sections').forEach(section => {
                    const title = section.querySelector('.subtitulo-decorado')?.textContent?.trim() || 'Sección';
                    const grid = section.querySelector('.planchas-grid');
                    const sel = grid ? grid.querySelector('.plancha-card.selected') : null;
                    result.push({ sectionEl: section, title, grid, sel });
                });
                return result;
            }

            function openModal(items){
                summaryContainer.innerHTML = '';
                items.forEach(item => {
                    const num = item.sel ? (item.sel.querySelector('.plancha-num')?.textContent || '') : '';
                    const nombre = item.sel ? (item.sel.querySelector('.plancha-nombre')?.textContent || '') : '';
                    const label = nombre ? `Plancha ${num} - ${nombre}` : `Plancha ${num}`;
                    
                    const summaryItem = document.createElement('div');
                    summaryItem.className = 'summary-item';
                    summaryItem.innerHTML = `
                        <span class="summary-consejo">${item.title}</span>
                        <span class="summary-plancha">${label}</span>
                    `;
                    summaryContainer.appendChild(summaryItem);
                });
                
                overlay.classList.add('show');
                document.body.style.overflow = 'hidden';
            }

            function closeModal(){ 
                overlay.classList.remove('show');
                document.body.style.overflow = '';
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check"></i> Confirmar Voto';
                }
            }

            if (registerBtn) {
                registerBtn.addEventListener('click', function() {
                    const data = getSectionSelections();
                    const missing = data.filter(d => !d.sel);
                    if(missing.length){
                        const m = missing[0];
                        if (m.grid) {
                            m.grid.classList.add('need-selection');
                            m.grid.scrollIntoView({ behavior:'smooth', block:'center' });
                            setTimeout(() => m.grid.classList.remove('need-selection'), 700);
                        }
                        return;
                    }
                    openModal(data);
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeModal();
                });
            }
            
            if (overlay) {
                overlay.addEventListener('click', function(e) { 
                    if(e.target === overlay) closeModal();
                });
            }
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                    setTimeout(() => { if (form) form.submit(); }, 500);
                });
            }

            document.addEventListener('keydown', function(e) {
                if(e.key === 'Escape' && overlay && overlay.classList.contains('show')) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
